# 라이브 스트리밍과 동영상 녹화

라이브 스트리밍 중에 동영상 녹화를 함께 제공하려면, 실시간으로 스트리밍을 하면서 동시에 해당 스트림을 파일로 저장하면 된다.

이는 일반적으로 RTMP 수신 서버(예: NGINX-RTMP) 또는 인코더(예: OBS), 혹은 FFmpeg 백엔드에서 처리한다.

## 방법 1: Nginx RTMP 모듈 녹화 기능 사용

NGINX-RTMP는 자체적으로 RTMP로 송출된 스트림을 .flv 형식으로 저장할 수 있다.

 - OBS로 송출할 때, 해당 스트림이 자동으로 /tmp/recordings/에 .flv 파일로 저장된다.
```conf
rtmp {
    server {
        listen 1935;

        application live {
            live on;

            record all;                      # 🔴 녹화 활성화
            record_path /tmp/recordings;     # 🔴 저장 경로
            record_suffix .flv;              # 🔴 저장 확장자
            record_unique on;                # 🔴 중복 방지 (타임스탬프 붙음)
        }
    }
}
```
<br/>

## 방법 2: OBS 자체에서 녹화 + 송출 동시에 설정

OBS에서는 라이브 방송 중 녹화도 병행할 수 있다.

해당 방식은 서버가 아니라 송출자(OBS 사용자)가 녹화본을 저장하게 된다.

 - 설정 > 출력 > 출력 모드: 고급
    - 방송: RTMP 송출
    - 녹화: 디스크에 mp4 저장
 - 녹화 품질, 경로, 코덱 모두 별도로 설정 가능

<br/>

## 방법 3: FFmpeg로 RTMP 스트림 받아서 저장

좀 더 유연하고 강력한 방식으로는 FFmpeg를 사용하여 RTMP 스트림을 받아 저장하는 방법이 있다.

 - 이 방식을 백그라운드로 실행하거나, 스트림 시작 감지 시 자동 실행 가능
```bash
# -c copy: 인코딩 없이 복사 저장 (빠름)
# -f mp4: 저장 포맷 지정
# 이 작업을 라이브 스트리밍과 동시에 실행하면 녹화본 생성 가능
ffmpeg -i rtmp://localhost/live/streamKey -c copy -f mp4 saved_video.mp4
```
<br/>

## 방법 4: HLS 세그먼트 → VOD 재조합

만약 HLS 세그먼트(.ts)와 .m3u8을 실시간으로 저장하고 있다면, 방송이 끝난 후 이를 하나의 VOD 파일로 병합할 수도 있다.

```bash
# FFmpeg로 .ts 파일 병합
# 실시간 저장은 안 되고, 방송이 끝난 후에만 가능
ffmpeg -i stream.m3u8 -c copy vod_output.mp4
```

## 구조별 선택 가이드

| 목적                | 추천 방식                    |
| ----------------- | ------------------------ |
| 서버에서 자동 녹화        | ✅ nginx-rtmp `record on` |
| 방송자 로컬 저장         | ✅ OBS에서 동시에 녹화 설정        |
| 파일 포맷/해상도 자유롭게 제어 | ✅ FFmpeg 백그라운드 인코딩       |
| 방송 끝나고 VOD만 생성    | ✅ `.m3u8` 기반 FFmpeg 병합   |

<br/>

 - `요약`

| 방법                  | 위치    | 특징                     |
| ------------------- | ----- | ---------------------- |
| nginx-rtmp `record` | 서버    | 설정만으로 자동 `.flv` 저장     |
| OBS 자체 녹화           | 클라이언트 | 송출자가 직접 파일 저장          |
| FFmpeg 인코딩          | 서버    | 포맷 제어, 병렬 저장 가능        |
| HLS 재조합             | 서버    | 세그먼트로부터 VOD 생성 (사후 처리) |
