# 미디어 스트리밍 구현 기술 정리

## 1. 스트리밍 추천 기술 (사용자수별)

WebRTC는 양방향, 초저지연, 소규모 통신에 적합하고, 유튜브 라이브처럼 대규모, 고품질, 단방향 방송에는 HLS/RTMP가 훨씬 유리합니다.

| 조건                   | 추천 기술                                             |
| -------------------- | ------------------------------------------------- |
| 10\~100명 대상 실시간 화상회의 | WebRTC + SFU                                      |
| 100\~1000명 대상 저지연 방송 | WebRTC + SFU or RTMP → WebRTC 게이트웨이               |
| 1000명\~무제한 대상 일반 방송  | RTMP ingest → HLS/DASH + CDN (YouTube, Twitch 구조) |


## 2. 라이브 스트리밍 구조

 - 시청자는 CDN을 통해 가까운 서버에서 영상 세그먼트를 가져옴
 - 대역폭, 지연 시간, 확장성 모두 우수
```less
[방송 송출자]
     │ RTMP 업로드
     ▼
[유튜브 인코딩 서버]
     └─▶ 트랜스코딩 (240p~1080p~4K 등)
          └─▶ 분할(HLS/DASH 세그먼트)
               └─▶ CDN 서버 (전 세계에 배포)
```
<br/>

 - `스트리밍 방식`
    - RTMP → 트랜스코딩 → HLS/DASH
    - OBS 같은 인코더가 RTMP로 영상 업로드
    - 서버가 다중 화질로 트랜스코딩
    - HLS나 DASH로 스트리밍 → CDN으로 전 세계 배포

```less
[방송 송출자]
     │ RTMP 업로드
     ▼
[유튜브 인코딩 서버]
     └─▶ 트랜스코딩 (240p~1080p~4K 등)
          └─▶ 분할(HLS/DASH 세그먼트)
               └─▶ CDN 서버 (전 세계에 배포)
```
<br/>

 - `RTMP → HLS 변환 구조`
    - __송출(OBS 등) → RTMP Ingest → HLS로 변환 → 사용자에게 스트리밍__
    - __RTMP 송출__: 방송 송출자가 rtmp://... 주소로 영상 스트림을 전송함 (예: OBS)
    - __RTMP 수신 서버__: RTMP를 수신하고, 실시간 인코딩 또는 분할을 수행 (예: nginx-rtmp-module, Wowza 등)
    - __HLS 트랜스코더__: 수신한 RTMP 스트림을 .m3u8 (playlist)와 .ts (segment)로 변환
    - __HTTP 서버__: .m3u8와 .ts를 사용자에게 HTTP로 전달 (웹 서버 또는 CDN 사용 가능)
    - __클라이언트__: HTML5 video 태그 또는 HLS 지원 플레이어로 영상 시청
```
[송출자]
  OBS, XSplit 등
     |
     | (RTMP)
     v
[RTMP 수신 서버]
  nginx-rtmp, Wowza, MediaLive 등
     |
     | (실시간 트랜스코딩 및 세그먼트 생성)
     v
[HLS 패키징 서버]
  .m3u8 (playlist) + .ts (video chunks)
     |
     | (HTTP)
     v
[클라이언트]
  Web Browser, 모바일 앱, TV 등
```

## 3. 라이브 스트리밍 흐름

 - `1. 송출(OBS)`
    - __RTMP 송출__: 방송 송출자가 rtmp://... 주소로 영상 스트림을 전송함
    - OBS는 사용자가 직접 "송출 서버 주소"와 "스트림 키"를 입력하여, 우리 NGINX RTMP 서버로 영상을 전송한다.
        - Server: rtmp://<우리 서버 IP>:1935/live
        - Stream Key: test123
    - OBS는 내부적으로 이 주소로 RTMP 프로토콜을 사용해 연결하고, 미디어 스트림을 전송한다.
    - NGINX는 이를 수신하고, 설정된 대로 .m3u8 / .ts 파일을 만들어 HLS로 제공하게 된다.
 - `2. RTMP 수신 서버(NGINX-RTMP 설정: nginx.conf)`
    - __RTMP 수신 서버__: RTMP를 수신하고, 실시간 인코딩 또는 분할을 수행
    - __HLS 트랜스코더__: 수신한 RTMP 스트림을 .m3u8 (playlist)와 .ts (segment)로 변환
```conf
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_fragment 5s;
            hls_playlist_length 15s;

            # 송출 전 스트림 키 검증
            on_publish http://localhost:8081/verify;
        }
    }
}
```
 - `3. HTTP 서버`
    - __HTTP 서버__: .m3u8와 .ts를 사용자에게 HTTP로 전달 (웹 서버 또는 CDN 사용 가능)
```conf
http {
    server {
        listen 8080;

        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
        }
    }
}
```
 - `4. 클라이언트 비디오 시청`
    - __클라이언트__: HTML5 video 태그 또는 HLS 지원 플레이어로 영상 시청
```html
<video controls autoplay>
  <source src="http://<server-ip>:8080/hls/test123.m3u8" type="application/x-mpegURL">
</video>
```

 - `구성 요약`
```
[OBS 송출자]
  rtmp://<server-ip>:1935/live/test123
     ↓
[NGINX RTMP 수신 + HLS 생성]
  /tmp/hls/test123.m3u8, *.ts
     ↓
[NGINX HTTP 서버]
  http://<server-ip>:8080/hls/test123.m3u8
     ↓
[브라우저 재생]
  HTML5 <video> 또는 hls.js
```


## 4. 스트림 키 검증 흐름

 - `스트림 키 검증 흐름`
```
[송출자]
  - OBS에 Stream URL: rtmp://your-server/live
  - Stream Key: abc123
     ↓
[NGINX-RTMP]
  - /live/abc123 로 요청 들어옴
  - on_publish → 백엔드 검증 API 호출
     ↓
[우리 API 서버]
  - DB나 Redis에서 abc123 유효한지 검사
  - OK면 송출 허용, 아니면 차단
```

 - `스트림 키 검증 설정 예시 (nginx.conf)`
    - application live 설정에 on_publish 추가
```conf
application live {
    live on;
    hls on;
    hls_path /tmp/hls;

    # 송출 전 스트림 키 검증
    on_publish http://localhost:8081/verify;
}
```

 - `검증용 백엔드 API 예시`
    - Nginx는 app, name, tcurl 필드를 포함한 application/x-www-form-urlencoded 형식으로 POST 요청을 보낸다.
    - app: RTMP application 이름 (예: live)
    - name: 스트림 키 (예: test123)
    - tcurl: 송출자가 연결한 RTMP URL 전체 (rtmp://example.com/live)
    - addr: 송출자의 IP 주소
    - flashver: 송출 클라이언트 버전 (OBS도 전송함)
```javascript
{
  "app": "live",
  "name": "abc123",
  "tcurl": "rtmp://your-server/live"
}
```

 - `백엔드 API 응답`
    - 허용할 경우: HTTP 200 응답
    - 차단할 경우: HTTP 403 응답
```json
HTTP/1.1 403 Forbidden
```

## 5. 구현 사항

라이브 스트리밍 서비스를 제공하는 회사 입장에서는 OBS나 RTMP 클라이언트의 내부 구현에 신경 쓸 필요는 없다. RTMP 수신 서버부터 책임을 지면 된다.

 - OBS (송출자 앱): 방송 송출자 (사용자)
 - RTMP 송출: OBS, XSplit, Larix Broadcaster 등
 - RTMP 수신 서버: 우리 서버 (nginx-rtmp, Wowza 등)
 - HLS 변환/전달: 우리 서버 or CDN
 - 시청자 재생 클라이언트: 웹 브라우저, 앱, Smart TV 등 (클라이언트 플레이어 제공)

### 5-1. 구현해야 할 것

 - `RTMP 수신 서버 구성`
    - NGINX RTMP 모듈 또는 Wowza, Nimble Streamer 등
    - 스트림을 받아 .m3u8 / .ts로 변환
 - `스트림 키 인증 (on_publish)`
    - 허가된 방송자만 송출 가능하도록 검증 API
 - `HLS 재생용 HTTP 서버 or CDN 연동`
    - 사용자에게 .m3u8 제공
    - 필요시 HTTPS 적용, 캐싱 정책 설정
 - `시청자용 재생 플레이어 제공`
    - HTML5 video 태그 또는 hls.js 기반 웹 플레이어
    - 또는 앱에서 HLS URL 재생
 - `(선택) 스트리밍 통계/모니터링`
    - 방송 시작/종료 로그 기록 (on_publish, on_done)
    - 실시간 시청자 수, 에러 로그 등
